name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
    paths-ignore:
      - 'README.md'
      - 'LICENSE'
      - 'docs/**'
      - '*.md'
      - '.gitignore'
  pull_request:
    branches: [ main ]
    paths-ignore:
      - 'README.md'
      - 'LICENSE'
      - 'docs/**'
      - '*.md'
      - '.gitignore'

env:
  NODE_VERSION: '20'

jobs:
  # Job de testing y linting
  test:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v5
      
    - name: ğŸ”§ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: ğŸ“¦ Install dependencies
      run: npm ci
      
    - name: ğŸ” Run ESLint
      run: npm run lint
      
    - name: ğŸ§ª Run tests with coverage
      run: npm test -- --coverage
      env:
        NODE_ENV: test
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        
    - name: ğŸ“Š Upload coverage reports
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: coverage-report
        path: coverage/
        retention-days: 30

  # Job de build y verificaciÃ³n
  build:
    needs: test
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v5
      
    - name: ğŸ”§ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: ğŸ“¦ Install dependencies
      run: npm ci --only=production
      
    - name: ğŸ—ï¸ Build verification
      run: |
        echo "ğŸ” Verificando estructura del proyecto..."
        ls -la
        echo "ğŸ“ Contenido de src/:"
        ls -la src/
        echo "âœ… Build verification completed"

  # Job de deployment (solo en main)
  deploy:
    needs: [test, build]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v5
      
    - name: ğŸš€ Deploy to Render
      env:
        RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
        RENDER_SERVICE_ID: ${{ secrets.RENDER_SERVICE_ID }}
      run: |
        echo "ğŸš€ Iniciando deployment a Render..."
        if [ -z "$RENDER_API_KEY" ]; then
          echo "âš ï¸  RENDER_API_KEY no configurado, saltando deployment"
          exit 0
        fi
        
        # Trigger deployment via Render API
        curl -X POST \
          "https://api.render.com/v1/services/$RENDER_SERVICE_ID/deploys" \
          -H "Authorization: Bearer $RENDER_API_KEY" \
          -H "Content-Type: application/json" \
          --data-raw '{}'
        
        echo "âœ… Deployment triggered successfully"
    
    - name: ğŸ‰ Deployment notification
      if: success()
      run: |
        echo "ğŸ‰ Deployment completado exitosamente!"
        echo "ğŸ”— La aplicaciÃ³n deberÃ­a estar disponible en breve"
        
    - name: ğŸ’¬ Notify on failure
      if: failure()
      run: |
        echo "âŒ Deployment fallÃ³. Revisa los logs para mÃ¡s detalles."

  # Job de notificaciÃ³n de estado
  notify:
    needs: [test, build, deploy]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: ğŸ“Š Pipeline Status
      run: |
        echo "ğŸ“Š Estado del Pipeline:"
        echo "  ğŸ§ª Tests: ${{ needs.test.result }}"
        echo "  ğŸ—ï¸  Build: ${{ needs.build.result }}"
        echo "  ğŸš€ Deploy: ${{ needs.deploy.result }}"
        
        if [ "${{ needs.test.result }}" = "success" ] && [ "${{ needs.build.result }}" = "success" ]; then
          echo "âœ… Pipeline ejecutado correctamente"
        else
          echo "âŒ Pipeline fallÃ³ en alguna etapa"
          exit 1
        fi